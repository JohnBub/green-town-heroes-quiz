<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üéÆ Verb Runner - Master Irregular Verbs!</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Nunito:wght@400;600;700;800;900&display=swap"
    rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Nunito', sans-serif;
      background-color: transparent;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    #app-wrapper {
      position: relative;
      width: 100%;
      max-width: 500px;
      height: 650px;
      max-height: 95vh;
      background: linear-gradient(180deg, #1a1a3e 0%, #0d1b2a 100%);
      border-radius: 24px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      overflow: hidden;
      border: 4px solid #2d3748;
      display: flex;
      flex-direction: column;
    }

    .snowflake {
      position: absolute;
      top: -20px;
      color: white;
      opacity: 0.6;
      pointer-events: none;
      animation: snowfall linear infinite;
      z-index: 1;
    }

    @keyframes snowfall {
      to {
        transform: translateY(900px) rotate(360deg);
      }
    }

    .screen {
      display: none;
      flex: 1;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 10;
      flex-direction: column;
      overflow-y: auto;
    }

    .screen.active {
      display: flex;
    }

    #menu-screen {
      align-items: center;
      justify-content: center;
      padding: 20px;
      text-align: center;
    }

    .game-title {
      font-family: 'Press Start 2P', cursive;
      font-size: 32px;
      background: linear-gradient(180deg, #ffd700, #ff8c00);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      filter: drop-shadow(2px 2px 0 #8b0000);
      margin-bottom: 10px;
    }

    .game-subtitle {
      font-size: 18px;
      color: #87ceeb;
      margin-bottom: 20px;
    }

    .xmas-decor {
      font-size: 40px;
      margin: 15px 0;
      animation: bounce 1s ease infinite;
    }

    @keyframes bounce {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-10px);
      }
    }

    .start-btn {
      font-family: 'Press Start 2P', cursive;
      font-size: 16px;
      padding: 16px 32px;
      background: linear-gradient(180deg, #22c55e, #16a34a);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 5px 0 #15803d;
      transition: all 0.1s;
    }

    .start-btn:hover {
      transform: translateY(-2px);
    }

    .start-btn:active {
      transform: translateY(2px);
      box-shadow: none;
    }

    .level-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin: 20px 0;
      width: 100%;
      padding: 0 10px;
    }

    ::-webkit-scrollbar {
      width: 0px;
      background: transparent;
    }

    .level-card {
      background: rgba(255, 255, 255, 0.08);
      border: 2px solid rgba(255, 255, 255, 0.15);
      border-radius: 10px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .level-card:hover {
      background: rgba(255, 255, 255, 0.15);
      border-color: #ffd700;
      transform: translateY(-3px);
    }

    .level-card h4 {
      font-family: 'Press Start 2P', cursive;
      font-size: 10px;
      color: #ffd700;
      margin-bottom: 6px;
    }

    .level-card p {
      color: #a5b4fc;
      font-size: 11px;
    }

    .instructions-box {
      background: rgba(0, 0, 0, 0.4);
      border-radius: 12px;
      padding: 15px;
      width: 100%;
      margin-top: 15px;
    }

    .instructions-box h3 {
      color: #ffd700;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .instructions-box p {
      color: #e2e8f0;
      font-size: 12px;
      line-height: 1.6;
      text-align: left;
    }

    .key-icon {
      display: inline-block;
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: bold;
      margin: 0 2px;
    }

    #game-screen {
      padding: 0;
      overflow: hidden;
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 15px;
      background: rgba(0, 0, 0, 0.6);
    }

    .level-info {
      display: flex;
      flex-direction: column;
    }

    .level-badge {
      font-family: 'Press Start 2P', cursive;
      font-size: 9px;
      color: #ffd700;
    }

    .level-name {
      font-size: 11px;
      color: #87ceeb;
    }

    .stats-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .lives-display {
      font-size: 18px;
    }

    .score-display {
      font-family: 'Press Start 2P', cursive;
      font-size: 10px;
      color: #ffd700;
    }

    .streak-display {
      background: linear-gradient(90deg, #f97316, #fbbf24);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 800;
      font-size: 13px;
    }

    .progress-section {
      padding: 4px 12px;
      background: rgba(0, 0, 0, 0.4);
    }

    .progress-bar {
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #22c55e, #4ade80);
      transition: width 0.3s;
    }

    .question-panel {
      background: linear-gradient(180deg, #7c2d12 0%, #991b1b 100%);
      padding: 15px 20px;
      border-bottom: 3px solid #ffd700;
      flex: 0 0 auto;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 150px;
    }

    .french-help {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .french-help.clickable {
      cursor: pointer;
    }

    .verb-pill {
      background: #ffd700;
      color: #1a1a2e;
      padding: 5px 14px;
      border-radius: 20px;
      font-weight: 800;
      font-size: 16px;
    }

    .equals {
      color: white;
      font-size: 18px;
      font-weight: bold;
    }

    .french-word {
      color: #86efac;
      font-size: 18px;
      font-weight: 700;
    }

    .tap-hint {
      color: rgba(255, 255, 255, 0.5);
      font-size: 11px;
    }

    .first-letter {
      color: #fbbf24;
      font-size: 14px;
      font-weight: 600;
    }

    .tense-badge {
      display: inline-block;
      align-self: center;
      background: rgba(255, 255, 255, 0.25);
      color: white;
      padding: 3px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .sentence-text {
      color: white;
      font-size: 18px;
      font-weight: 700;
      text-align: center;
      line-height: 1.3;
      text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
    }

    .sentence-context {
      color: rgba(255, 255, 255, 0.75);
      font-size: 13px;
      text-align: center;
      margin-top: 6px;
      font-style: italic;
    }

    .answer-section {
      background: linear-gradient(180deg, #1e3a5f 0%, #172554 100%);
      padding: 10px 15px;
      flex: 0 0 auto;
    }

    .answer-label {
      text-align: center;
      color: #94a3b8;
      font-size: 10px;
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .enter-key {
      display: inline-block;
      background: #ffd700;
      color: #1a1a2e;
      padding: 2px 6px;
      border-radius: 4px;
      font-weight: 800;
      text-transform: none;
    }

    .answer-options {
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .answer-option {
      flex: 1;
      max-width: 140px;
      padding: 12px 6px;
      background: rgba(255, 255, 255, 0.95);
      border: 3px solid #cbd5e1;
      border-radius: 12px;
      text-align: center;
      font-size: 15px;
      font-weight: 800;
      color: #1e293b;
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
    }

    .answer-option:hover {
      transform: scale(1.03);
      border-color: #94a3b8;
    }

    .answer-option.selected {
      border-color: #ffd700;
      background: #fef9c3;
      transform: scale(1.05);
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
    }

    .answer-option.correct {
      background: #86efac;
      border-color: #22c55e;
      color: #166534;
    }

    .answer-option.wrong {
      background: #fca5a5;
      border-color: #ef4444;
      color: #991b1b;
    }

    .lane-indicator {
      display: none;
    }

    .timer-section {
      background: rgba(0, 0, 0, 0.7);
      padding: 8px 15px;
      flex: 0 0 auto;
    }

    .timer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .timer-label {
      font-family: 'Press Start 2P', cursive;
      font-size: 9px;
      color: white;
    }

    .timer-warning {
      color: #fbbf24;
      font-size: 11px;
      font-weight: 800;
      animation: blink 0.5s ease infinite;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.4;
      }
    }

    .timer-bar {
      height: 10px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 6px;
      overflow: hidden;
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .timer-fill {
      height: 100%;
      border-radius: 8px;
      transition: width 0.05s linear, background 0.3s;
    }

    .timer-fill.safe {
      background: linear-gradient(90deg, #22c55e, #4ade80);
    }

    .timer-fill.warning {
      background: linear-gradient(90deg, #f59e0b, #fbbf24);
    }

    .timer-fill.danger {
      background: linear-gradient(90deg, #dc2626, #ef4444);
      animation: pulse 0.3s ease infinite;
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.7;
      }
    }

    .runner-track {
      flex: 1;
      position: relative;
      background: linear-gradient(180deg, #1e3a5f 0%, #0f172a 100%);
      overflow: hidden;
      min-height: 150px;
    }

    .track-lines {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      justify-content: space-around;
      padding: 0 10%;
    }

    .track-line {
      width: 4px;
      height: 100%;
      background: repeating-linear-gradient(180deg, #ffd700 0px, #ffd700 20px, transparent 20px, transparent 40px);
      opacity: 0.5;
      animation: scrollLines 0.6s linear infinite;
    }

    @keyframes scrollLines {
      from {
        transform: translateY(0);
      }

      to {
        transform: translateY(40px);
      }
    }

    .lanes-visual {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
    }

    .lane-visual {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border-left: 1px solid rgba(255, 255, 255, 0.1);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
    }

    .lane-visual.active {
      background: rgba(255, 215, 0, 0.1);
    }

    .trees-row {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      font-size: 28px;
      opacity: 0.7;
    }

    .ground {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 10px;
      background: linear-gradient(180deg, #f0f9ff 0%, #e0f2fe 100%);
      border-top: 3px solid #bae6fd;
    }

    .runner-character {
      font-size: 50px;
      position: absolute;
      bottom: 25px;
      left: 50%;
      transform: translateX(-50%) scaleX(-1);
      transition: left 0.15s ease-out;
      filter: drop-shadow(2px 4px 8px rgba(0, 0, 0, 0.5));
      z-index: 10;
      animation: runBob 0.25s ease infinite alternate;
    }

    .runner-character.lane-0 {
      left: 16.66%;
    }

    .runner-character.lane-1 {
      left: 50%;
    }

    .runner-character.lane-2 {
      left: 83.33%;
    }

    @keyframes runBob {
      from {
        transform: translateX(-50%) translateY(0) scaleX(-1);
      }

      to {
        transform: translateX(-50%) translateY(-6px) scaleX(-1);
      }
    }

    .controls-section {
      display: flex;
      justify-content: center;
      gap: 30px;
      padding: 15px;
      background: rgba(0, 0, 0, 0.4);
      flex: 0 0 auto;
    }

    .control-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.95), rgba(240, 240, 240, 0.95));
      border: 4px solid #ffd700;
      font-size: 26px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.1s;
      user-select: none;
    }

    .control-btn:hover {
      transform: scale(1.1);
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    .feedback-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }

    .feedback-overlay.active {
      display: flex;
    }

    .feedback-popup {
      padding: 30px 40px;
      border-radius: 20px;
      text-align: center;
      animation: popIn 0.3s ease;
    }

    @keyframes popIn {
      from {
        transform: scale(0);
      }

      to {
        transform: scale(1);
      }
    }

    .feedback-popup.correct {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      box-shadow: 0 10px 40px rgba(34, 197, 94, 0.5);
    }

    .feedback-popup.incorrect {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      box-shadow: 0 10px 40px rgba(239, 68, 68, 0.5);
    }

    .feedback-icon {
      font-size: 60px;
      margin-bottom: 10px;
    }

    .feedback-text {
      font-family: 'Press Start 2P', cursive;
      font-size: 20px;
      color: white;
    }

    .feedback-answer {
      font-size: 16px;
      color: rgba(255, 255, 255, 0.9);
      margin-top: 10px;
    }

    .overlay-screen {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.92);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 20px;
      text-align: center;
    }

    .overlay-screen.active {
      display: flex;
    }

    .overlay-icon {
      font-size: 70px;
      margin-bottom: 15px;
      animation: bounce 1s ease infinite;
    }

    .overlay-title {
      font-family: 'Press Start 2P', cursive;
      font-size: 24px;
      margin-bottom: 15px;
    }

    .overlay-title.success {
      color: #4ade80;
    }

    .overlay-title.failure {
      color: #ef4444;
    }

    .overlay-title.victory {
      background: linear-gradient(90deg, #ffd700, #ff6b35);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .overlay-stats {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px 30px;
      border-radius: 12px;
      margin: 15px 0;
    }

    .overlay-stats p {
      color: #e2e8f0;
      font-size: 16px;
      margin: 8px 0;
    }

    .big-score {
      font-family: 'Press Start 2P', cursive;
      font-size: 24px;
      color: #ffd700;
    }

    .overlay-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .overlay-btn {
      font-family: 'Press Start 2P', cursive;
      font-size: 11px;
      padding: 14px 22px;
      border-radius: 10px;
      cursor: pointer;
      border: none;
      transition: all 0.1s;
    }

    .overlay-btn.primary {
      background: linear-gradient(180deg, #22c55e, #16a34a);
      color: white;
      box-shadow: 0 4px 0 #15803d;
    }

    .overlay-btn.secondary {
      background: linear-gradient(180deg, #6366f1, #4f46e5);
      color: white;
      box-shadow: 0 4px 0 #4338ca;
    }

    .overlay-btn:hover {
      transform: translateY(-2px);
    }

    .overlay-btn:active {
      transform: translateY(2px);
      box-shadow: none;
    }

    @media (max-width: 520px) {
      body {
        padding: 0;
        background: #0d1b2a;
      }

      #app-wrapper {
        border-radius: 0;
        box-shadow: none;
        border: none;
        max-width: 100%;
        height: 100vh;
        max-height: none;
      }
    }
  </style>
</head>

<body>

  <div id="app-wrapper">
    <div id="snowflakes"></div>

    <div id="menu-screen" class="screen active">
      <h1 class="game-title">üéÆ VERB RUNNER</h1>
      <p class="game-subtitle">Master Irregular Verbs!</p>
      <div class="xmas-decor">üéÑ‚≠êüéÖ‚≠êüéÑ</div>
      <button id="btn-start" class="start-btn">‚ñ∂ START GAME</button>
      <div class="level-grid" id="level-grid"></div>
      <div class="instructions-box">
        <h3>üéØ Comment jouer / How to Play</h3>
        <p>
          üìù Lis la phrase et choisis la bonne r√©ponse<br>
          ‚¨ÖÔ∏è‚û°Ô∏è <span class="key-icon">‚Üê</span> <span class="key-icon">‚Üí</span> pour changer ‚Ä¢ <span
            class="key-icon">ENTER</span> pour valider<br>
          ‚è±Ô∏è Attention au temps !<br>
          ‚ù§Ô∏è 3 vies par niveau ‚Ä¢ üèÜ 5 niveaux √† compl√©ter !
        </p>
      </div>
    </div>

    <div id="game-screen" class="screen">
      <div class="game-header">
        <div class="level-info">
          <span class="level-badge" id="level-badge">Level 1</span>
          <span class="level-name" id="level-name">Beginner Forest</span>
        </div>
        <div class="stats-row">
          <span class="lives-display" id="lives-display">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
          <span class="score-display" id="score-display">0</span>
          <span class="streak-display" id="streak-display"></span>
        </div>
      </div>

      <div class="progress-section">
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>

      <div class="question-panel">
        <div class="french-help" id="french-help"></div>
        <div class="tense-badge" id="tense-badge">Past Simple</div>
        <p class="sentence-text" id="sentence-text"></p>
        <p class="sentence-context" id="sentence-context"></p>
      </div>

      <div class="answer-section">
        <div class="answer-label">‚Üê ‚Üí to select ‚Ä¢ <span class="enter-key">ENTER</span> to confirm</div>
        <div class="answer-options" id="answer-options"></div>
      </div>

      <div class="timer-section">
        <div class="timer-header">
          <span class="timer-label">‚è±Ô∏è TIME</span>
          <span class="timer-warning" id="timer-warning" style="display:none;">‚ö° D√âP√äCHE-TOI !</span>
        </div>
        <div class="timer-bar">
          <div class="timer-fill safe" id="timer-fill"></div>
        </div>
      </div>

      <div class="runner-track">
        <div class="track-lines">
          <div class="track-line"></div>
          <div class="track-line"></div>
        </div>
        <div class="lanes-visual" id="lanes-visual">
          <div class="lane-visual" id="lane-0"></div>
          <div class="lane-visual active" id="lane-1"></div>
          <div class="lane-visual" id="lane-2"></div>
        </div>
        <div class="trees-row">
          <span>üå≤</span><span>üéÑ</span><span>üå≤</span><span>üéÑ</span><span>üå≤</span>
        </div>
        <div class="ground"></div>
        <div class="runner-character lane-1" id="runner">üèÉ</div>
      </div>

      <div class="controls-section">
        <button id="btn-left" class="control-btn">‚¨ÖÔ∏è</button>
        <button id="btn-right" class="control-btn">‚û°Ô∏è</button>
      </div>
    </div>

    <div class="feedback-overlay" id="feedback-overlay">
      <div class="feedback-popup" id="feedback-popup">
        <div class="feedback-icon" id="feedback-icon">‚úÖ</div>
        <div class="feedback-text" id="feedback-text">CORRECT!</div>
        <div class="feedback-answer" id="feedback-answer"></div>
      </div>
    </div>

    <div class="overlay-screen" id="level-complete-screen">
      <div class="overlay-icon">üéâ</div>
      <h2 class="overlay-title success" id="level-complete-title">LEVEL 1 COMPLETE!</h2>
      <div class="overlay-stats">
        <p>Score: <span class="big-score" id="complete-score">0</span></p>
        <p id="complete-lives">Lives: ‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</p>
      </div>
      <div class="overlay-buttons">
        <button id="btn-next-level" class="overlay-btn primary">NEXT LEVEL ‚Üí</button>
        <button id="btn-menu-complete" class="overlay-btn secondary">MENU</button>
      </div>
    </div>

    <div class="overlay-screen" id="game-over-screen">
      <div class="overlay-icon">üíî</div>
      <h2 class="overlay-title failure">GAME OVER</h2>
      <div class="overlay-stats">
        <p>Level: <span id="gameover-level">1</span></p>
        <p>Score: <span class="big-score" id="gameover-score">0</span></p>
      </div>
      <div class="overlay-buttons">
        <button id="btn-retry" class="overlay-btn primary">TRY AGAIN</button>
        <button id="btn-menu-fail" class="overlay-btn secondary">MENU</button>
      </div>
    </div>

    <div class="overlay-screen" id="victory-screen">
      <div class="overlay-icon">üèÜ</div>
      <h2 class="overlay-title victory">üéÑ CHAMPION! üéÑ</h2>
      <p style="color: #87ceeb; font-size: 15px; margin-bottom: 10px;">Tu as ma√Ætris√© tous les verbes irr√©guliers !</p>
      <div class="overlay-stats">
        <p>Final Score: <span class="big-score" id="victory-score">0</span></p>
        <p style="color: #ffd700;">‚≠ê Joyeux No√´l! ‚≠ê</p>
      </div>
      <div class="overlay-buttons">
        <button id="btn-play-again" class="overlay-btn primary">PLAY AGAIN</button>
        <button id="btn-menu-victory" class="overlay-btn secondary">MENU</button>
      </div>
    </div>

  </div>

  <script>
    // ============================================
    // VERB DATA - USE GLOBAL SCOPE to prevent redeclaration errors
    // ============================================
    window.ALL_VERBS = window.ALL_VERBS || [
      ['be', 'was/were', 'been', '√™tre'],
      ['have', 'had', 'had', 'avoir'],
      ['do', 'did', 'done', 'faire'],
      ['go', 'went', 'gone', 'aller'],
      ['come', 'came', 'come', 'venir'],
      ['get', 'got', 'got', 'obtenir'],
      ['make', 'made', 'made', 'faire/fabriquer'],
      ['say', 'said', 'said', 'dire'],
      ['see', 'saw', 'seen', 'voir'],
      ['take', 'took', 'taken', 'prendre'],
      ['know', 'knew', 'known', 'savoir/conna√Ætre'],
      ['think', 'thought', 'thought', 'penser'],
      ['give', 'gave', 'given', 'donner'],
      ['find', 'found', 'found', 'trouver'],
      ['tell', 'told', 'told', 'raconter/dire'],
      ['eat', 'ate', 'eaten', 'manger'],
      ['drink', 'drank', 'drunk', 'boire'],
      ['buy', 'bought', 'bought', 'acheter'],
      ['bring', 'brought', 'brought', 'apporter'],
      ['put', 'put', 'put', 'mettre'],
      ['read', 'read', 'read', 'lire'],
      ['write', 'wrote', 'written', '√©crire'],
      ['run', 'ran', 'run', 'courir'],
      ['sit', 'sat', 'sat', '√™tre assis'],
      ['stand', 'stood', 'stood', '√™tre debout'],
      ['sleep', 'slept', 'slept', 'dormir'],
      ['speak', 'spoke', 'spoken', 'parler'],
      ['meet', 'met', 'met', 'rencontrer'],
      ['pay', 'paid', 'paid', 'payer'],
      ['feel', 'felt', 'felt', 'ressentir'],
      ['leave', 'left', 'left', 'partir/quitter'],
      ['begin', 'began', 'begun', 'commencer'],
      ['break', 'broke', 'broken', 'casser'],
      ['build', 'built', 'built', 'construire'],
      ['catch', 'caught', 'caught', 'attraper'],
      ['choose', 'chose', 'chosen', 'choisir'],
      ['cut', 'cut', 'cut', 'couper'],
      ['draw', 'drew', 'drawn', 'dessiner'],
      ['drive', 'drove', 'driven', 'conduire'],
      ['fall', 'fell', 'fallen', 'tomber'],
      ['fly', 'flew', 'flown', 'voler'],
      ['forget', 'forgot', 'forgotten', 'oublier'],
      ['grow', 'grew', 'grown', 'grandir/pousser'],
      ['hear', 'heard', 'heard', 'entendre'],
      ['hold', 'held', 'held', 'tenir'],
      ['keep', 'kept', 'kept', 'garder'],
      ['let', 'let', 'let', 'laisser'],
      ['become', 'became', 'become', 'devenir'],
      ['beat', 'beat', 'beaten', 'battre'],
      ['bite', 'bit', 'bitten', 'mordre'],
      ['blow', 'blew', 'blown', 'souffler'],
      ['cost', 'cost', 'cost', 'co√ªter'],
      ['feed', 'fed', 'fed', 'nourrir'],
      ['fight', 'fought', 'fought', 'se battre'],
      ['hang', 'hung', 'hung', 'accrocher'],
      ['hide', 'hid', 'hidden', 'cacher'],
      ['hit', 'hit', 'hit', 'frapper'],
      ['hurt', 'hurt', 'hurt', 'blesser'],
      ['lead', 'led', 'led', 'mener'],
      ['lend', 'lent', 'lent', 'pr√™ter'],
      ['lie', 'lay', 'lain', '√™tre allong√©'],
      ['lose', 'lost', 'lost', 'perdre'],
      ['mean', 'meant', 'meant', 'signifier'],
      ['can', 'could', 'been able', 'pouvoir'],
      ['ride', 'rode', 'ridden', 'monter (v√©lo)'],
      ['ring', 'rang', 'rung', 'sonner'],
      ['rise', 'rose', 'risen', 'se lever'],
      ['sell', 'sold', 'sold', 'vendre'],
      ['send', 'sent', 'sent', 'envoyer'],
      ['set', 'set', 'set', 'mettre/r√©gler'],
      ['shine', 'shone', 'shone', 'briller'],
      ['shoot', 'shot', 'shot', 'tirer'],
      ['show', 'showed', 'shown', 'montrer'],
      ['shut', 'shut', 'shut', 'fermer'],
      ['sing', 'sang', 'sung', 'chanter'],
      ['sink', 'sank', 'sunk', 'couler'],
      ['spend', 'spent', 'spent', 'd√©penser'],
      ['spread', 'spread', 'spread', 'r√©pandre'],
      ['steal', 'stole', 'stolen', 'voler'],
      ['stick', 'stuck', 'stuck', 'coller'],
      ['swim', 'swam', 'swum', 'nager'],
      ['teach', 'taught', 'taught', 'enseigner'],
      ['throw', 'threw', 'thrown', 'lancer'],
      ['understand', 'understood', 'understood', 'comprendre'],
      ['wake', 'woke', 'woken', 'se r√©veiller'],
      ['wear', 'wore', 'worn', 'porter'],
      ['win', 'won', 'won', 'gagner'],
    ];

    window.SENTENCE_TEMPLATES = window.SENTENCE_TEMPLATES || {
      'be': [
        { sentence: "Yesterday, I ___ very tired.", answer: 1, context: "Hier, j'√©tais tr√®s fatigu√©." },
        { sentence: "She has ___ sick for three days.", answer: 2, context: "Elle est malade depuis trois jours." },
      ],
      'have': [
        { sentence: "Last week, we ___ a big party.", answer: 1, context: "La semaine derni√®re, nous avons eu une grande f√™te." },
        { sentence: "I have ___ this phone for two years.", answer: 2, context: "J'ai ce t√©l√©phone depuis deux ans." },
      ],
    };

    // Fill in basic templates for all verbs to ensure no errors
    window.ALL_VERBS.forEach(v => {
      if (!window.SENTENCE_TEMPLATES[v[0]]) {
        window.SENTENCE_TEMPLATES[v[0]] = [
          { sentence: `Yesterday, I ___ (${v[0]}).`, answer: 1, context: "" },
          { sentence: `I have ___ (${v[0]}).`, answer: 2, context: "" }
        ];
      }
    });

    window.LEVEL_CONFIG = window.LEVEL_CONFIG || {
      1: { verbs: window.ALL_VERBS.slice(0, 15), timeLimit: 15000, showFrench: 'full', questionsCount: 10, name: 'Beginner Forest' },
      2: { verbs: window.ALL_VERBS.slice(0, 31), timeLimit: 13000, showFrench: 'full', questionsCount: 12, name: 'Snowy Hills' },
      3: { verbs: window.ALL_VERBS.slice(0, 47), timeLimit: 11000, showFrench: 'hover', questionsCount: 14, name: 'Ice Cave' },
      4: { verbs: window.ALL_VERBS.slice(0, 63), timeLimit: 9000, showFrench: 'hint', questionsCount: 16, name: 'Mountain Peak' },
      5: { verbs: window.ALL_VERBS, timeLimit: 7000, showFrench: 'none', questionsCount: 18, name: "Santa's Castle" },
    };

    // Game state - also attached to window to persist
    window.gameState = window.gameState || {
      currentLevel: 1,
      lives: 3,
      score: 0,
      streak: 0,
      currentLane: 1,
      questionIndex: 0,
      questions: [],
      timeLeft: 100,
      timerInterval: null,
      showingFeedback: false,
      showingHint: false
    };

    // Helper functions for safely getting elements and setting text/style
    function setText(id, text) {
      const el = document.getElementById(id);
      if (el) el.textContent = text;
    }

    function setHtml(id, html) {
      const el = document.getElementById(id);
      if (el) el.innerHTML = html;
    }

    function safeAddListener(id, event, handler) {
      const el = document.getElementById(id);
      if (!el) return;
      // cloning replacement to strip old listeners
      // const newEl = el.cloneNode(true);
      // el.parentNode.replaceChild(newEl, el);
      // newEl.addEventListener(event, handler);
      // NOTE: simple addEventListener is fine if we init once. 
      // But if init runs multiple times, we might stack listeners?
      // Let's just use onclick property for safety against stacking
      el['on' + event] = handler;
    }

    window.initGame = function () {
      createSnowflakes();
      createLevelCards();
      setupInteractiveControls();
    }

    function createSnowflakes() {
      const container = document.getElementById('snowflakes');
      if (!container) return;
      container.innerHTML = '';
      for (let i = 0; i < 25; i++) {
        const flake = document.createElement('div');
        flake.className = 'snowflake';
        flake.textContent = '‚ùÑ';
        flake.style.left = Math.random() * 100 + '%';
        flake.style.animationDelay = Math.random() * 5 + 's';
        flake.style.animationDuration = (4 + Math.random() * 4) + 's';
        flake.style.fontSize = (8 + Math.random() * 12) + 'px';
        container.appendChild(flake);
      }
    }

    function createLevelCards() {
      const grid = document.getElementById('level-grid');
      if (!grid) return;
      grid.innerHTML = '';
      for (let i = 1; i <= 5; i++) {
        const card = document.createElement('div');
        card.className = 'level-card';
        card.innerHTML = `<h4>Level ${i}</h4><p>${window.LEVEL_CONFIG[i].name}</p>`;
        card.onclick = () => window.startLevel(i);
        grid.appendChild(card);
      }
    }

    function setupInteractiveControls() {
      safeAddListener('btn-start', 'click', () => window.startLevel(1));

      safeAddListener('btn-left', 'click', () => window.selectLane(Math.max(0, window.gameState.currentLane - 1)));
      safeAddListener('btn-right', 'click', () => window.selectLane(Math.min(2, window.gameState.currentLane + 1)));

      safeAddListener('btn-next-level', 'click', window.nextLevel);
      safeAddListener('btn-menu-complete', 'click', window.showMenu);

      safeAddListener('btn-retry', 'click', window.retryLevel);
      safeAddListener('btn-menu-fail', 'click', window.showMenu);

      safeAddListener('btn-play-again', 'click', () => { window.gameState.score = 0; window.startLevel(1); });
      safeAddListener('btn-menu-victory', 'click', window.showMenu);

      safeAddListener('lane-0', 'click', () => window.selectLane(0));
      safeAddListener('lane-1', 'click', () => window.selectLane(1));
      safeAddListener('lane-2', 'click', () => window.selectLane(2));

      // Global keydown is safe to just add once, or remove old one
      if (window.gameKeyHandler) {
        document.removeEventListener('keydown', window.gameKeyHandler);
      }
      window.gameKeyHandler = (e) => {
        if (window.gameState.showingFeedback) return;
        if (e.key === 'ArrowLeft') window.selectLane(Math.max(0, window.gameState.currentLane - 1));
        else if (e.key === 'ArrowRight') window.selectLane(Math.min(2, window.gameState.currentLane + 1));
        else if (e.key === 'Enter') window.submitAnswer();
      };
      document.addEventListener('keydown', window.gameKeyHandler);
    }

    window.showScreen = function (screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.overlay-screen').forEach(s => s.classList.remove('active'));
      const el = document.getElementById(screenId);
      if (el) el.classList.add('active');
    }

    window.showMenu = function () {
      if (window.gameState.timerInterval) clearInterval(window.gameState.timerInterval);
      window.showScreen('menu-screen');
    }

    function generateQuestions(level) {
      const config = window.LEVEL_CONFIG[level];
      const verbs = [...config.verbs].sort(() => Math.random() - 0.5).slice(0, config.questionsCount);

      return verbs.map(verb => {
        const [infinitive, pastSimple, pastParticiple, french] = verb;
        const templates = window.SENTENCE_TEMPLATES[infinitive] || window.SENTENCE_TEMPLATES['be'];

        let template;
        if (templates && templates.length > 0) {
          template = templates[Math.floor(Math.random() * templates.length)];
        } else {
          const usePast = Math.random() > 0.5;
          template = {
            sentence: usePast ? `Yesterday, I ___ (${infinitive})` : `I have ___ (${infinitive})`,
            answer: usePast ? 1 : 2,
            context: ''
          }
        }

        const correctAnswer = template.answer === 1 ? pastSimple : pastParticiple;
        const others = config.verbs.filter(v => v[0] !== infinitive).sort(() => Math.random() - 0.5);
        if (others.length < 2) return null;

        const distractors = [others[0][template.answer], others[1][template.answer]];
        const options = [correctAnswer, ...distractors].sort(() => Math.random() - 0.5);
        const correctLane = options.indexOf(correctAnswer);

        return {
          infinitive,
          french,
          sentence: template.sentence,
          context: template.context,
          correctAnswer,
          options,
          correctLane,
          tenseHint: template.answer === 1 ? 'Past Simple' : 'Past Participle',
        };
      }).filter(q => q !== null);
    }

    window.startLevel = function (level) {
      window.gameState.currentLevel = level;
      window.gameState.lives = 3;
      window.gameState.streak = 0;
      window.gameState.currentLane = 1;
      window.gameState.questionIndex = 0;
      window.gameState.timeLeft = 100;
      window.gameState.showingFeedback = false;

      if (level === 1) window.gameState.score = 0;

      window.gameState.questions = generateQuestions(level);

      window.showScreen('game-screen');
      updateUI();
      showQuestion();
      startTimer();
    }

    function updateUI() {
      const gs = window.gameState;
      const levelConfig = window.LEVEL_CONFIG[gs.currentLevel];
      if (!levelConfig) return;

      setText('level-badge', `Level ${gs.currentLevel}`);
      setText('level-name', levelConfig.name);
      setText('lives-display', '‚ù§Ô∏è'.repeat(Math.max(0, gs.lives)) + 'üñ§'.repeat(Math.max(0, 3 - gs.lives)));
      setText('score-display', gs.score);
      setText('streak-display', gs.streak > 1 ? `üî•x${gs.streak}` : '');

      const pFill = document.getElementById('progress-fill');
      if (pFill) pFill.style.width = (gs.questions.length > 0 ? (gs.questionIndex / gs.questions.length * 100) : 0) + '%';
    }

    function showQuestion() {
      const gs = window.gameState;
      if (!gs.questions[gs.questionIndex]) return;

      const q = gs.questions[gs.questionIndex];
      const config = window.LEVEL_CONFIG[gs.currentLevel];

      const frenchHelp = document.getElementById('french-help');
      if (frenchHelp) {
        frenchHelp.onclick = null;
        let html = '';
        if (config.showFrench === 'full') {
          html = `<span class="verb-pill">${q.infinitive}</span><span class="equals">=</span><span class="french-word">${q.french}</span>`;
          frenchHelp.className = 'french-help';
        } else if (config.showFrench === 'hover') {
          html = gs.showingHint
            ? `<span class="verb-pill">${q.infinitive}</span><span class="equals">=</span><span class="french-word">${q.french}</span>`
            : `<span class="verb-pill">${q.infinitive}</span><span class="tap-hint">üëÜ Tap for French</span>`;
          frenchHelp.className = 'french-help clickable';
          frenchHelp.onclick = () => { gs.showingHint = !gs.showingHint; showQuestion(); };
        } else if (config.showFrench === 'hint') {
          html = `<span class="verb-pill">${q.infinitive}</span><span class="first-letter">(${q.french[0]}...)</span>`;
          frenchHelp.className = 'french-help';
        } else {
          html = `<span class="verb-pill">${q.infinitive}</span>`;
          frenchHelp.className = 'french-help';
        }
        frenchHelp.innerHTML = html;
      }

      setText('tense-badge', q.tenseHint);
      setText('sentence-text', q.sentence);
      setText('sentence-context', config.showFrench === 'full' ? q.context : '');

      const optionsContainer = document.getElementById('answer-options');
      if (optionsContainer) {
        optionsContainer.innerHTML = '';
        q.options.forEach((opt, idx) => {
          const div = document.createElement('div');
          div.className = 'answer-option' + (idx === gs.currentLane ? ' selected' : '');
          div.innerHTML = `${opt}<div class="lane-indicator ${idx === gs.currentLane ? 'active' : ''}">${idx === 0 ? '‚Üê LEFT' : idx === 1 ? 'CENTER' : 'RIGHT ‚Üí'}</div>`;
          div.onclick = () => window.selectLane(idx);
          div.ondblclick = () => { window.selectLane(idx); window.submitAnswer(); };
          optionsContainer.appendChild(div);
        });
      }

      updateRunner();
      updateLanes();
    }

    window.selectLane = function (lane) {
      if (window.gameState.showingFeedback) return;
      window.gameState.currentLane = lane;

      document.querySelectorAll('.answer-option').forEach((opt, idx) => {
        opt.classList.toggle('selected', idx === lane);
        const indicator = opt.querySelector('.lane-indicator');
        if (indicator) indicator.classList.toggle('active', idx === lane);
      });

      updateRunner();
      updateLanes();
    }

    function updateRunner() {
      const runner = document.getElementById('runner');
      if (runner) runner.className = 'runner-character lane-' + window.gameState.currentLane;
    }

    function updateLanes() {
      document.querySelectorAll('.lane-visual').forEach((lane, idx) => {
        lane.classList.toggle('active', idx === window.gameState.currentLane);
      });
    }

    function startTimer() {
      if (window.gameState.timerInterval) clearInterval(window.gameState.timerInterval);
      window.gameState.timeLeft = 100;
      const config = window.LEVEL_CONFIG[window.gameState.currentLevel];
      const decrementRate = 100 / (config.timeLimit / 50);

      window.gameState.timerInterval = setInterval(() => {
        if (window.gameState.showingFeedback) return;

        window.gameState.timeLeft -= decrementRate;
        const timeLeft = window.gameState.timeLeft;

        const timerFill = document.getElementById('timer-fill');
        if (timerFill) {
          timerFill.style.width = Math.max(0, timeLeft) + '%';
          timerFill.className = 'timer-fill ' + (timeLeft > 50 ? 'safe' : timeLeft > 25 ? 'warning' : 'danger');
        }

        const warning = document.getElementById('timer-warning');
        if (warning) warning.style.display = timeLeft < 30 ? 'inline' : 'none';

        if (timeLeft <= 0) {
          window.submitAnswer();
        }
      }, 50);
    }

    window.submitAnswer = function () {
      const gs = window.gameState;
      if (gs.showingFeedback) return;
      gs.showingFeedback = true;
      if (gs.timerInterval) clearInterval(gs.timerInterval);

      const q = gs.questions[gs.questionIndex];
      const correct = gs.currentLane === q.correctLane;

      document.querySelectorAll('.answer-option').forEach((opt, idx) => {
        if (idx === q.correctLane) opt.classList.add('correct');
        if (idx === gs.currentLane && !correct) opt.classList.add('wrong');
      });

      const overlay = document.getElementById('feedback-overlay');
      const popup = document.getElementById('feedback-popup');
      const icon = document.getElementById('feedback-icon');
      const text = document.getElementById('feedback-text');
      const answer = document.getElementById('feedback-answer');

      if (popup) popup.className = 'feedback-popup ' + (correct ? 'correct' : 'incorrect');
      if (icon) icon.textContent = correct ? '‚úÖ' : '‚ùå';
      if (text) text.textContent = correct ? 'CORRECT!' : 'WRONG!';
      if (answer) {
        answer.textContent = correct ? '' : '‚û°Ô∏è ' + q.correctAnswer;
        answer.style.display = correct ? 'none' : 'block';
      }
      if (overlay) overlay.classList.add('active');

      if (correct) {
        gs.score += 100 * gs.currentLevel + gs.streak * 20;
        gs.streak++;
      } else {
        gs.lives--;
        gs.streak = 0;
      }

      updateUI();

      setTimeout(() => {
        if (overlay) overlay.classList.remove('active');

        if (!correct && gs.lives <= 0) {
          showGameOver();
        } else if (gs.questionIndex >= gs.questions.length - 1) {
          if (gs.currentLevel >= 5) {
            showVictory();
          } else {
            showLevelComplete();
          }
        } else {
          gs.questionIndex++;
          gs.showingFeedback = false;
          gs.showingHint = false;
          gs.currentLane = 1;
          showQuestion();
          updateUI();
          startTimer();
        }
      }, correct ? 1500 : 2500);
    }

    function showLevelComplete() {
      setText('level-complete-title', `LEVEL ${window.gameState.currentLevel} COMPLETE!`);
      setText('complete-score', window.gameState.score);
      setText('complete-lives', 'Lives: ' + '‚ù§Ô∏è'.repeat(Math.max(0, window.gameState.lives)));

      const el = document.getElementById('level-complete-screen');
      if (el) el.classList.add('active');
    }

    function showGameOver() {
      setText('gameover-level', window.gameState.currentLevel);
      setText('gameover-score', window.gameState.score);
      const el = document.getElementById('game-over-screen');
      if (el) el.classList.add('active');
    }

    function showVictory() {
      setText('victory-score', window.gameState.score);
      const el = document.getElementById('victory-screen');
      if (el) el.classList.add('active');
    }

    window.nextLevel = function () {
      const el = document.getElementById('level-complete-screen');
      if (el) el.classList.remove('active');
      window.startLevel(window.gameState.currentLevel + 1);
    }

    window.retryLevel = function () {
      const el = document.getElementById('game-over-screen');
      if (el) el.classList.remove('active');
      window.startLevel(window.gameState.currentLevel);
    }

    // Initialize - use load event but also self-init if late
    if (document.readyState === 'complete') {
      window.initGame();
    } else {
      window.addEventListener('load', window.initGame);
    }
  </script>

  <script>
    function adjustIframeHeight() {
      const bodyHeight = document.body.scrollHeight;
      const htmlHeight = document.documentElement.scrollHeight;
      const height = Math.max(bodyHeight, htmlHeight);

      window.parent.postMessage(
        {
          interactionCode: 'verb_runner_game',
          type: 'SET_INSTRUCTION_HEIGHT',
          value: height,
        },
        '*'
      );
    }

    if (window.ResizeObserver) {
      const observer = new ResizeObserver(() => adjustIframeHeight());
      observer.observe(document.body);
    } else {
      setInterval(adjustIframeHeight, 1000);
    }

    window.addEventListener('load', adjustIframeHeight);
    window.addEventListener('resize', adjustIframeHeight);
  </script>
</body>

</html>